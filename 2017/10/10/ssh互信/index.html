<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Zhangguanzhang">
  <!-- Open Graph Data -->
  <meta property="og:title" content="ssh互信"/>
  <meta property="og:description" content="记录生活点滴" />
  <meta property="og:site_name" content="Zhangguanzhang"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="http://zhangguanzhang.github.ioundefined"/>
  <meta name="baidu-site-verification" content="RqbanSZBE3" />
  
    <link rel="alternate" href="/atom.xml" title="Zhangguanzhang" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>Zhangguanzhang</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.dark.css">

  <!-- Google Analytics -->
  

</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/default-banner-dark.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">ssh互信</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/zhangguanzhang">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:zhangguanzhang@qq.com">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>


<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By Zhangguanzhang</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2017-10-10</span>
            <span class="time">16:10:11</span>
          </span>
          
        </div>
        <!-- Tags -->
        
        <!-- Post Main Content -->
        <div class="post-content">
          <p>ssh公钥免密码登录<br><a id="more"></a><br><img src="http://mmbiz.qpic.cn/mmbiz_jpg/IP70Vic417DPlnSnZ9Dfrm0DkSHG5zWEy0wGzmZ0S27a6dwjziaRicDQeicgcStBpfiaU3RDGzUbUTh4bAibQiccKBMaA/640.jpeg?tp=webp&wxfrom=5&wx_lazy=1" alt=""><br>ssh-keygen命令用来生成公钥和私钥密钥对的工具，通常用法是-t指定加密算法,-f指定输出路径，一般是~/.ssh/id_rsa，-P是指定私钥密码</p>
<pre><code>[root@guan ~]# ssh-keygen -t rsa    # -t参数指定算法，可以是rsa或dsa
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa):  # 询问私钥保存路径
Enter passphrase (empty for no passphrase):               # 询问是否加密私钥文件
Enter same passphrase again:            
Your identification has been saved in /root/.ssh/id_rsa. 
Your public key has been saved in /root/.ssh/id_rsa.pub.</code></pre>

<p>如果不想被询问，则可以使用下面一条命令完成：”-f”指定私钥文件，”-P”指定passphrase，或者”-N”也一样。</p>
<pre><code>[root@guan ~]# ssh-keygen -t rsa -f ~/.ssh/id_rsa -P ''   # 指定加密私钥文件的密码为空密码，即不加密
</code></pre>

<p>然后用ssh-copy-id分发公钥，ssh-copy-id用法很简单，只需指定待信任主机及目标用户即可。如果生成的公钥文件，路径不是~/.ssh/id_rsa.pub，则使用”-i”选项指定要分发的公钥。<br>例如分发到192.168.1.105上</p>
<pre><code>[root@guan ~]# ssh-copy-id 192.168.1.105
root@192.168.1.105's password:   #输入目标主机密码即可
</code></pre>

<p>ssh-copy-id唯一需要注意的是，如果ssh服务端的端口不是22，则需要给ssh-copy-id传递端口号，传递方式为”-p port_num [user@]hostname”，例如”-p 22222 root@172.16.10.6”。之所以要如此传递，见下面摘自ssh-copy-id中公钥分发的命令部分。</p>
<pre><code>{ eval "$GET_ID" ; } | ssh $1 "umask 077; test -d ~/.ssh || mkdir ~/.ssh ; cat >> ~/.ssh/authorized_keys && (test -x /sbin/restorecon && /sbin/restorecon ~/.ssh ~/.ssh/authorized_keys >/dev/null 2>&1 || true)" || exit 1</code></pre>

<p>其中”{ eval “$GET_ID” ; }”可理解为待分发的本地公钥内容，”(test -x /sbin/restorecon &amp;&amp; /sbin/restorecon ~/.ssh ~/.ssh/authorized_keys &gt;/dev/null 2&gt;&amp;1 || true)”和selinux有关，不用管，所以上述命令简化为：</p>
<pre><code>cat ~/.ssh/id_rsa.pub | ssh $1 "umask 077; test -d ~/.ssh || mkdir ~/.ssh ; cat >> ~/.ssh/authorized_keys || exit 1</code></pre>

<p>可见，ssh-copy-id的所有参数都是存储在位置变量$1中传递给ssh，所以应该将ssh的端口选项”-p port_num”和user@hostname放在一起传递。</p>
<p>通过分析上面的命令，也即知道了ssh-copy-id的作用：在目标主机的指定用户的家目录下，检测是否有~/.ssh目录，如果没有，则以700权限创建该目录，然后将本地的公钥追加到目标主机指定用户家目录下的~/.ssh/authorized_keys文件中。</p>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

