<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Zhangguanzhang">
  <!-- Open Graph Data -->
  <meta property="og:title" content="shell多进程并发执行"/>
  <meta property="og:description" content="记录生活点滴" />
  <meta property="og:site_name" content="Zhangguanzhang"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="https://zhangguanzhang.github.ioundefined"/>
  <meta name="baidu-site-verification" content="RqbanSZBE3" />
  
    <link rel="alternate" href="/atom.xml" title="Zhangguanzhang" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>Zhangguanzhang</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.dark.css">

  <!-- Google Analytics -->
  

</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/default-banner-dark.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">shell多进程并发执行</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/zhangguanzhang">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:zhangguanzhang@qq.com">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>


<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By Zhangguanzhang</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2017-04-15</span>
            <span class="time">17:17:13</span>
          </span>
          
          <!--  Categories  -->
            <span class="categories info">Under 

<a href="/categories/日志/">日志</a>
</span>
          
        </div>
        <!-- Tags -->
        
          <div class="post-tags text-muted">
            Tags: 

<a class="tag" href="/tags/linux/">#linux</a> <a class="tag" href="/tags/shell/">#shell</a>


          </div>
        
        <!-- Post Main Content -->
        <div class="post-content">
          <p>图文记录下shell多进程<br><a id="more"></a></p>
<h3 id="虽说shell的多进程是后台执行-但是学会了再写一些脚本的时候非常方便"><a href="#虽说shell的多进程是后台执行-但是学会了再写一些脚本的时候非常方便" class="headerlink" title="虽说shell的多进程是后台执行,但是学会了再写一些脚本的时候非常方便"></a>虽说shell的多进程是后台执行,但是学会了再写一些脚本的时候非常方便</h3><p>先看传统的后台多进程方式,写个shell来举例<br>先是正常的运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@guan ~]<span class="comment"># cat&gt;test.sh&lt;&lt;'eof'</span></div><div class="line">&gt; <span class="comment">#!/bin/bash</span></div><div class="line">&gt; start=`date +%s`</div><div class="line">&gt; <span class="keyword">for</span> i <span class="keyword">in</span> `seq 10`;<span class="keyword">do</span></div><div class="line">&gt; <span class="built_in">echo</span> <span class="variable">$i</span>;sleep 2</div><div class="line">&gt; <span class="keyword">done</span></div><div class="line">&gt; <span class="built_in">echo</span> <span class="string">'Time:'</span> <span class="string">"<span class="variable">$((`date +%s`-start)</span>)"</span></div><div class="line">&gt; eof</div><div class="line">[root@guan ~]<span class="comment"># sh test.sh</span></div><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">Time: 20</div><div class="line">[root@guan ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>然后是后台运行来节约时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@guan ~]<span class="comment"># cat&gt;test.sh&lt;&lt;'EOF'</span></div><div class="line">&gt; <span class="comment">#!/bin/bash</span></div><div class="line">&gt; start=`date +%s`</div><div class="line">&gt; <span class="keyword">for</span> i <span class="keyword">in</span> `seq 10`;<span class="keyword">do</span></div><div class="line">&gt;  &#123; <span class="built_in">echo</span> <span class="variable">$i</span>;sleep 2; &#125;&amp; <span class="comment">#后台运行</span></div><div class="line">&gt; <span class="keyword">done</span></div><div class="line">&gt; <span class="built_in">wait</span> <span class="comment">#等待所有后台进程运行完成</span></div><div class="line">&gt; <span class="built_in">echo</span> <span class="string">'Time:'</span> <span class="string">"<span class="variable">$((`date +%s`-start)</span>)"</span></div><div class="line">&gt; EOF</div><div class="line">[root@guan ~]<span class="comment"># sh test.sh </span></div><div class="line">1</div><div class="line">2</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">9</div><div class="line">4</div><div class="line">8</div><div class="line">3</div><div class="line">10</div><div class="line">Time: 2</div><div class="line">[root@guan ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>从上面结果对比发现时间大大缩短,但是缺点是不能控制数量<br>然后因为wait特性我们可以用它来配合数字来自定并发的数量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@guan ~]<span class="comment"># cat&gt;test.sh&lt;&lt;'EOF'</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">max_process=5;</div><div class="line">start=`date +%s`</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq 10`;<span class="keyword">do</span></div><div class="line">	&#123; <span class="built_in">echo</span> <span class="variable">$i</span>;sleep 2; &#125;&amp; <span class="comment">#后台运行</span></div><div class="line">	((count++));((do_count++)) <span class="comment"># 次数和运行的次数计数</span></div><div class="line">	[ <span class="string">"do_count"</span> <span class="_">-eq</span> <span class="string">'10'</span> ] &amp;&amp; &#123; <span class="built_in">wait</span>;<span class="built_in">break</span>; &#125; <span class="comment"># 这里的10是需要执行的总次数,运行过的次数等于总次数就等待所有后台退出,但是假设每次并发,的次数是3,最后有一个进程,上下俩行就是为了防止这种情况出现</span></div><div class="line"></div><div class="line">	[ <span class="string">"<span class="variable">$count</span>"</span> <span class="_">-eq</span> <span class="string">"<span class="variable">$max_process</span>"</span> ] &amp;&amp; &#123; <span class="built_in">wait</span>;count=0; &#125;</div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'Time:'</span> <span class="string">"<span class="variable">$((`date +%s`-start)</span>)"</span></div><div class="line">EOF</div><div class="line">[root@guan ~]<span class="comment"># sh test.sh </span></div><div class="line">1</div><div class="line">2</div><div class="line">4</div><div class="line">5</div><div class="line">3</div><div class="line">6</div><div class="line">7</div><div class="line">10</div><div class="line">9</div><div class="line">8</div><div class="line">Time: 4</div><div class="line">[root@guan ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>这种还要考虑需要并发的进程数量在总次数下是否有余数的可能,后面我发现了可以用mkfifo来实现并发,代码更容易懂<br>无名管道： 就是我们经常使用的 例如： cat text | grep “abc”<br>那个“|”就是管道，只不过是无名的，可以直接作为两个进程的数据通道<br>有名管道： mkfilo  可以创建一个管道文件 ，例如： mkfifo　fifo_file<br>管道有一个特点，如果管道中没有数据，那么取管道数据的操作就会停滞，直到<br>管道内进入数据，然后读出后才会终止这一操作，同理，写入管道的操作</p>
<p>如果没有读取操作，这一个动作也会停滞。<br><img src="http://s3.51cto.com/wyfs02/M00/24/7C/wKiom1NQHk-DQPSDAABjOdvRLD4666.jpg" alt=""><br>当我们试图用echo想管道文件中写入数据时，由于没有任何进程在对它做读取操作，所以<br>它会一直停留在那里等待读取操作，此时我们在另一终端上用cat指令做读取操作<br><img src="http://s3.51cto.com/wyfs02/M02/24/7B/wKioL1NQHibQwp6rAACaUgamBvs703.jpg" alt=""><br>你会发现读取操作一旦执行，写入操作就可以顺利完成了，同理，先做读取操作也是一样的(不信可以自行测试)</p>
<p>后面发现的多进程就是利用管道的读写来控制,exec绑定文件操作符重定向</p>
<p>exec绑定文件操作符后我们来试试按行读取会有啥现象</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@guan ~]<span class="comment"># exec 5&lt;&gt;test_fifo</span></div><div class="line">[root@guan ~]<span class="comment"># echo '123' &gt;&amp;5</span></div><div class="line">[root@guan ~]<span class="comment"># read -u5  #-u选项是表示从文件描叙符里读取管道里的一行</span></div><div class="line">[root@guan ~]<span class="comment"># read -u5</span></div><div class="line">^C			<span class="comment">#上面管道里只有一行,读取第二行会停滞在这</span></div><div class="line">[root@guan ~]<span class="comment"># echo -e '123\n123' &gt;&amp;5</span></div><div class="line">[root@guan ~]<span class="comment"># read -u5</span></div><div class="line">[root@guan ~]<span class="comment"># read -u5</span></div><div class="line">[root@guan ~]<span class="comment"># read -u5</span></div><div class="line">^C          <span class="comment">#管道里俩行,读取第三行会停滞</span></div></pre></td></tr></table></figure>
<p>管道来并发控制就是先在管道里写入要并发数量的行数<br>每次read一行后后面把要后台的任务用大括号包起来后台了<br>然后大括号里面的最后一句是向管道里写入一行,只有后台任务执行完了下一个read -u才不会停滞<br>举个例子3条任务,并发数量为2,一开始管道里写入2行<br>然后下面代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">mkfifo test_fifo</div><div class="line"><span class="built_in">exec</span> 5&lt;&gt;test_fifo</div><div class="line">rm <span class="_">-f</span> test_fifo</div><div class="line">seq 2&gt;&amp;5</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..3&#125;;<span class="keyword">do</span></div><div class="line">	<span class="built_in">read</span> -u5</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">echo</span> <span class="variable">$i</span>;sleep 2;  <span class="comment">#需要并发的内容统一写在大括号里</span></div><div class="line">		<span class="built_in">echo</span> &gt;&amp;5</div><div class="line">	&#125;&amp;</div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="built_in">wait</span></div></pre></td></tr></table></figure>
<p>脑补下执行过程,进入循环中:<br>第一次read(管道里有2行)不会被停滞,管道剩下1行,大括号里的所有代码放在后台(一个后台并发)<br>第二次read(管道里有1行)不会被停滞,管道剩下0行,大括号里的所有代码放在后台(俩个后台并发)<br>第三次read(管道里有0行),会被停滞,只有等一个后台执行完了(后台里最后一句)向管道里写入了一个空行,此次的read才会退出停滞状态后面的代码才能继续执行<br>然后循环结束后最后还有第三次的后台,此处写个wait即可</p>
<p>然后下面是完整的例子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">[root@guan ~]<span class="comment"># cat -n test.sh </span></div><div class="line">     1	<span class="comment">#!/bin/bash</span></div><div class="line">     2	</div><div class="line">     3	<span class="built_in">trap</span> <span class="string">"exec 5&gt;&amp;-;exec 5&lt;$-;exit 0"</span> 2   <span class="comment">#捕捉中断信号2(ctrl+C)关闭fd5的意思,善后工作</span></div><div class="line">     4	</div><div class="line">     5	max_process=<span class="variable">$1</span></div><div class="line">     6	</div><div class="line">     7	pipe=`mktemp -u tmp.XXXX`</div><div class="line">     8	mkfifo <span class="variable">$pipe</span></div><div class="line">     9	<span class="built_in">exec</span> 5&lt;&gt;<span class="variable">$pipe</span>      <span class="comment">#这个数值不是0,1,2就行,范围是3-$((`ulimit -u`-1))</span></div><div class="line">    10	rm <span class="_">-f</span> <span class="variable">$pipe</span></div><div class="line">    11	</div><div class="line">    12	seq <span class="variable">$max_process</span>&gt;&amp;5   <span class="comment">#写入并发数量的行</span></div><div class="line">    13	</div><div class="line">    14	start=`date +%s`</div><div class="line">    15	<span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..10&#125;;<span class="keyword">do</span></div><div class="line">    16		<span class="built_in">read</span> -u5</div><div class="line">    17		&#123;</div><div class="line">    18			<span class="built_in">echo</span> <span class="variable">$i</span>;sleep 2;</div><div class="line">    19			<span class="built_in">echo</span> &gt;&amp;5</div><div class="line">    20		&#125;&amp;</div><div class="line">    21	<span class="keyword">done</span></div><div class="line">    22	<span class="built_in">wait</span></div><div class="line">    23	<span class="built_in">echo</span> <span class="string">'Time:'</span> <span class="string">"<span class="variable">$((`date +%s`-start)</span>)"</span></div><div class="line">    24	</div><div class="line">    25	<span class="built_in">exec</span> 5&gt;$-;<span class="built_in">exec</span> 5&lt;$-   <span class="comment">#关闭文件操作符必须分开写</span></div><div class="line">[root@guan ~]<span class="comment"># sh test.sh 2</span></div><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">Time: 10</div><div class="line">[root@guan ~]<span class="comment"># sh test.sh 9</span></div><div class="line">1</div><div class="line">2</div><div class="line">4</div><div class="line">6</div><div class="line">7</div><div class="line">9</div><div class="line">8</div><div class="line">5</div><div class="line">3</div><div class="line">10</div><div class="line">Time: 4</div><div class="line">[root@guan ~]<span class="comment">#</span></div></pre></td></tr></table></figure>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

